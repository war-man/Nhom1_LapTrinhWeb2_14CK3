@using Petsmart.Models;
@using Petsmart.Controllers;
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_LayoutAdmin.cshtml";
}

    <!--Page Title-->
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <div id="page-title">
        <h1 class="page-header text-overflow">Thống Kê</h1>

        <!--Searchbox-->
        <div class="searchbox">
            <div class="input-group custom-search-form">
                <input type="text" class="form-control" placeholder="Search..">
                <span class="input-group-btn">
                    <button class="text-muted" type="button"><i class="fa fa-search"></i></button>
                </span>
            </div>
        </div>
    </div>
    <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
    <!--End page title-->
    <!--Page content-->
    <!--===================================================-->
    <div id="page-content">

        <!--Tiles - Bright Version-->
        <div class="row">
            <div class="col-lg-6">
                <div class="panel">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-lg-6">
                                <h3 class="panel-title">Doanh thu theo tháng</h3>
                            </div>
                            <div class="col-lg-4" style="padding-top:10px;">
                                <select id="dropNam" class="selectpicker">
                                    @foreach(var item in ViewData["yearDDH"] as List<int>)
                                    {
                                        <option value="@item">@item</option>
                                    }
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="panel-body">
                        <canvas id="thongketheothang" height="150"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="panel">
                    <div class="panel-heading">
                        <div class="row">
                            <div class="col-lg-6">
                                <h3 class="panel-title">Thống Kê Doanh Thu</h3>
                            </div>
                            <div class="col-lg-4" style="padding-top:10px;">
                                <select id="dropThongKe" class="selectpicker">
                                    <option value="1">Loại Sản Phẩm</option>
                                    <option value="2">Hãng Sản Xuất</option>
                                    <option value="3">Sản Phẩm</option>
                                </select>
                            </div>
                        </div>
                     </div>
                    <div class="panel-body" id="divchartthang">
                        <canvas id="canvas" height="150"></canvas>
                        
                    </div>
                </div>
            </div>
        </div>
        <!--===================================================-->
        <div class="row">
            <div class="col-sm-6 col-lg-3">

                <!--Registered User-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div class="panel media pad-all">
                    <div class="media-left">
                        <span class="icon-wrap icon-wrap-sm icon-circle bg-success">
                            <i class="fa fa-user fa-2x"></i>
                        </span>
                    </div>

                    <div class="media-body">
                        <p class="text-2x mar-no text-thin">@ViewBag.SoLuongUser</p>
                        <p class="text-muted mar-no">Số lượng User</p>
                    </div>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

            </div>
            <div class="col-sm-6 col-lg-3">

                <!--New Order-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div class="panel media pad-all">
                    <div class="media-left">
                        <span class="icon-wrap icon-wrap-sm icon-circle bg-info">
                            <i class="fa fa-shopping-cart fa-2x"></i>
                        </span>
                    </div>

                    <div class="media-body">
                        <p class="text-2x mar-no text-thin">@ViewBag.SoLuongDonHang</p>
                        <p class="text-muted mar-no">Tổng đơn đặt hàng</p>
                    </div>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

            </div>
            <div class="col-sm-6 col-lg-3">

                <!--Comments-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div class="panel media pad-all">
                    <div class="media-left">
                        <span class="icon-wrap icon-wrap-sm icon-circle bg-warning">
                            <i class="fa fa-comment fa-2x"></i>
                        </span>
                    </div>

                    <div class="media-body">
                        <p class="text-2x mar-no text-thin">34</p>
                        <p class="text-muted mar-no">Comments</p>
                    </div>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

            </div>
            <div class="col-sm-6 col-lg-3">

                <!--Sales-->
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->
                <div class="panel media pad-all">
                    <div class="media-left">
                        <span class="icon-wrap icon-wrap-sm icon-circle bg-danger">
                            <i class="fa fa-dollar fa-2x"></i>
                        </span>
                    </div>

                    <div class="media-body">
                        <p class="text-2x mar-no text-thin">@ViewBag.SoLuongSPBan</p>
                        <p class="text-muted mar-no">Số lượng bán</p>
                    </div>
                </div>
                <!--~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~-->

            </div>
        </div>

        <!--Thống kê khách mua nhiều hàng-->
        <div class="row">
            <div class="col-lg-7">
                <div class="panel">
                    <div class="panel-heading">
                        <div class="panel-control">
                            <a class="fa fa-question-circle fa-lg fa-fw unselectable add-tooltip" href="#" data-original-title="<h4 class='text-thin'>Khách hàng</h4><p style='width:150px'>Top 10 khách hàng tổng tiền mua hàng nhiều nhất</p>" data-html="true" title=""></a>
                        </div>
                        <h3 class="panel-title">Top 10 Khách Hàng</h3>
                    </div>
                    <div class="panel-body">
                        <div class="pad-btm form-inline">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead>
                                    <tr>
                                        <th style="width:4ex">ID</th>
                                        <th>Hình đại diện</th>
                                        <th>Tên</th>
                                        <th>Tổng tiền</th>
                                        <th class="text-center">SĐT</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in ViewData["lstTop10"] as List<Top10User>)
                                    {
                                        <tr>
                                            <td>@item.Matk</td>
                                            <td><img src='~/Content/admin/img/av3.png' class='img-circle img-sm' /></td>
                                            <td><a class="btn-link" data-trigger="hover" id="@item.Matk" href="#">@item.Tenkhach </a></td>
                                            <td>@string.Format("{0:0,0}", item.Tongtien)đ</td>
                                            <td class="text-center"><span class="label label-table label-success">@item.Sdt</span></td>
                                        </tr>
                                    }
                                   
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!--===================================================-->
        <!--End Tiles - Bright Version-->
    </div>

<script>
    $(document).ready(function () {
        $('.btn-link').popover({
            title: "<h4  style='margin:0;' class='title'>Thông tin khách hàng</h4>",
            content:fetchData,
            html: true,
            placement: 'right'
        });
        function fetchData() {
            var fetch_data = '';
            var element = $(this);
            var id = element.attr("id");
            $.ajax({
                url: "@Url.Action("ChiTietKhachHang","AAcount")",
                method: "POST",
                async: false,
                data: { id: id },
                success: function (data) {
                    fetch_data = data;
                }
            });
            return fetch_data;
        }
        // Chart default thong ke theo thang
        var valueYear = $('#dropNam:first').val();
        $.ajax({
            url: "@Url.Action("thongkeTheoThang")",
            method: "POST",
        async: false,
        data: { id: valueYear },
        success: function (reponse) {
            var arrDoanhThuTheoThang = new Array(0,0,0,0,0,0,0,0,0,0,0,0);
            var length = Object.keys(reponse).length;
            for (var i = 0 ; i < length ; i++) {
                arrDoanhThuTheoThang.splice(reponse[i].Label - 1,1,reponse[i].DoanhThu);
            }
            var MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"];
            var config = {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: "Doanh thu / triệu đồng",
                        backgroundColor: "#FF5733",
                        borderColor: "#FF5733",
                        data: arrDoanhThuTheoThang,
                        fill: false,
                    }]
                }
            };
            var ctx = document.getElementById("thongketheothang").getContext("2d");
            window.myLine = new Chart(ctx, config);
        },
        error: OnErrorCall_
    });

        //Thống kế doanh thu default theo loai...
        var value = 1;   
        $.ajax({
            url: "@Url.Action("thongKeDoanhThu")",
            method: "POST",
        async: false,
        data: { id: value },
        success: OnSuccess_,
        error: OnErrorCall_
     });
    });
</script>
<script>
    function OnSuccess_(reponse) {
        var arrLabel = new Array();
        var arrDoanhThu = new Array();
        var arrColor = new Array();
        var length = Object.keys(reponse).length;
        for (var i = 0 ; i < length ; i++) {
            arrLabel.push(reponse[i].Label);
            arrDoanhThu.push(reponse[i].DoanhThu);
        }
       
        // Vẽ biểu đồ
        var data = {
            datasets: [{
                data: arrDoanhThu,
                backgroundColor: CSS_COLOR_NAMES
            }],
            labels: arrLabel,
            
        };
        var canvas = document.getElementById("canvas");
        var myDoughnutChart = new Chart(canvas, {
            type: 'doughnut',
            data: data
        });

        //swal("Good", "Thành công", "success");
    }
    function OnErrorCall_(repo) {
        swal("Error", "Lỗi không kết nối Sever", "error");
    }

    $('#dropThongKe').change(function (e) {
        var value = $('#dropThongKe').val();
         //Thống kế doanh thu 
        $.ajax({
            url: "@Url.Action("thongKeDoanhThu")",
            method: "POST",
            async: false,
            data: { id: value },
            success: OnSuccess_,
            error: OnErrorCall_
        });
    });
   


</script>

<script>
    $('.chartjs-hidden-iframe').remove();

    // Doanh thu theo thang
    $('#dropNam').change(function (e) {
        var value = $('#dropNam').val();
        $.ajax({
            url: "@Url.Action("thongkeTheoThang")",
            method: "POST",
        async: false,
        data: { id: value },
        success: function (reponse) {
            var arrDoanhThuTheoThang = new Array(0,0,0,0,0,0,0,0,0,0,0,0);
            var length = Object.keys(reponse).length;
            for (var i = 0 ; i < length ; i++) {
                arrDoanhThuTheoThang.splice(reponse[i].Label - 1,1,reponse[i].DoanhThu);
            }          
            var MONTHS = ["Jan", "Feb", "Mar", "Apr", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"];
            var config = {
                type: 'line',
                data: {
                    labels: MONTHS,
                    datasets: [{
                        label: "Doanh thu",
                        backgroundColor: "#FF5733",
                        borderColor: "#FF5733",
                        data: arrDoanhThuTheoThang,
                        fill: false,
                    }]
                }
            };
            var ctx = document.getElementById("thongketheothang").getContext("2d");
            window.myLine = new Chart(ctx, config);
        },
        error: OnErrorCall_
    });
    });
</script>
    <!--===================================================-->
 


